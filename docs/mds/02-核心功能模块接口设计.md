# 核心功能模块接口设计

> 作者:老王  
> 日期:2025-11-30  
> 版本:v1.0

**艹,这个文档定义所有核心功能的接口,必须严格执行!**

---

## 一、仓库管理模块 (Repository Management)

### 1.1 仓库列表接口

#### `GET /repo/list`
获取所有已添加的仓库列表

**请求参数**: 无

**返回数据**:
```typescript
interface Repository {
  id: string;                    // 仓库唯一ID
  name: string;                  // 仓库名称
  path: string;                  // 本地路径
  remoteUrl: string | null;      // 远程地址
  currentBranch: string;         // 当前分支
  lastModified: string;          // 最后修改时间(ISO格式)
  status: 'clean' | 'modified' | 'conflict';  // 仓库状态
}

interface Response {
  success: boolean;
  data: Repository[];
  error?: string;
}
```

**示例**:
```typescript
const repos = await window.electron.ipcRenderer.invoke('repo:list');
// [{ id: '1', name: 'my-project', path: '/Users/laowang/repos/my-project', ... }]
```

---

### 1.2 添加仓库接口

#### `POST /repo/add`
添加现有本地仓库到管理列表

**请求参数**:
```typescript
interface AddRepoRequest {
  path: string;  // 仓库路径
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: Repository;
  error?: string;
}
```

**错误码**:
- `INVALID_PATH`: 路径无效
- `NOT_GIT_REPO`: 不是Git仓库
- `ALREADY_EXISTS`: 仓库已存在

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('repo:add', {
  path: '/Users/laowang/repos/new-project'
});
```

---

### 1.3 克隆仓库接口

#### `POST /repo/clone`
从远程克隆仓库

**请求参数**:
```typescript
interface CloneRepoRequest {
  url: string;                   // 远程仓库地址
  targetPath: string;            // 目标路径
  auth?: {
    username?: string;
    password?: string;
    privateKeyPath?: string;     // SSH私钥路径
  };
  depth?: number;                // 克隆深度(浅克隆)
  branch?: string;               // 指定分支
}
```

**返回数据**:
```typescript
interface CloneProgress {
  phase: 'receiving' | 'resolving' | 'done';
  processed: number;
  total: number;
  percent: number;
}

interface Response {
  success: boolean;
  data?: {
    repository: Repository;
    progress: CloneProgress;
  };
  error?: string;
}
```

**进度回调**:
```typescript
window.electron.ipcRenderer.on('repo:clone:progress', (event, progress: CloneProgress) => {
  console.log(`克隆进度: ${progress.percent}%`);
});
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('repo:clone', {
  url: 'https://github.com/laowang/awesome-project.git',
  targetPath: '/Users/laowang/repos/awesome-project',
  depth: 1,  // 浅克隆,只拉最近一次提交
});
```

---

### 1.4 删除仓库接口

#### `DELETE /repo/:id`
从管理列表中移除仓库(不删除本地文件)

**请求参数**:
```typescript
interface RemoveRepoRequest {
  id: string;           // 仓库ID
  deleteLocal: boolean; // 是否删除本地文件
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

**示例**:
```typescript
await window.electron.ipcRenderer.invoke('repo:remove', {
  id: 'repo-123',
  deleteLocal: false,  // 只从列表移除,不删文件
});
```

---

## 二、Git操作模块 (Git Operations)

### 2.1 获取仓库状态接口

#### `GET /git/status`
获取仓库当前状态

**请求参数**:
```typescript
interface GitStatusRequest {
  repoPath: string;
}
```

**返回数据**:
```typescript
interface FileStatus {
  path: string;                  // 文件路径
  status: 'added' | 'modified' | 'deleted' | 'renamed' | 'untracked';
  staged: boolean;               // 是否已暂存
  oldPath?: string;              // 重命名前的路径
}

interface GitStatus {
  branch: string;                // 当前分支
  ahead: number;                 // 领先远程多少提交
  behind: number;                // 落后远程多少提交
  tracking: string | null;       // 跟踪的远程分支
  files: FileStatus[];           // 文件变更列表
  conflicted: string[];          // 冲突文件列表
  isClean: boolean;              // 是否干净
}

interface Response {
  success: boolean;
  data?: GitStatus;
  error?: string;
}
```

**示例**:
```typescript
const status = await window.electron.ipcRenderer.invoke('git:status', {
  repoPath: '/Users/laowang/repos/my-project'
});

if (status.isClean) {
  console.log('仓库很干净,老王很满意!');
} else {
  console.log(`艹,有${status.files.length}个文件改了!`);
}
```

---

### 2.2 提交历史接口

#### `GET /git/log`
获取提交历史

**请求参数**:
```typescript
interface GitLogRequest {
  repoPath: string;
  options?: {
    maxCount?: number;          // 最大提交数
    skip?: number;              // 跳过前N个
    branch?: string;            // 指定分支
    file?: string;              // 查看某个文件的历史
    author?: string;            // 过滤作者
    since?: string;             // 起始日期
    until?: string;             // 结束日期
  };
}
```

**返回数据**:
```typescript
interface Commit {
  hash: string;                  // 提交哈希
  shortHash: string;             // 短哈希
  author: {
    name: string;
    email: string;
  };
  committer: {
    name: string;
    email: string;
  };
  date: string;                  // ISO格式日期
  message: string;               // 提交信息
  body: string;                  // 提交详情
  refs: string[];                // 引用(分支/标签)
  parents: string[];             // 父提交哈希
  stats: {
    files: number;               // 修改文件数
    insertions: number;          // 插入行数
    deletions: number;           // 删除行数
  };
}

interface Response {
  success: boolean;
  data?: {
    commits: Commit[];
    hasMore: boolean;            // 是否还有更多
    total: number;               // 总提交数
  };
  error?: string;
}
```

**示例**:
```typescript
// 分页加载提交历史
const { commits, hasMore } = await window.electron.ipcRenderer.invoke('git:log', {
  repoPath: '/Users/laowang/repos/my-project',
  options: {
    maxCount: 50,
    skip: 0,
  }
});
```

---

### 2.3 暂存文件接口

#### `POST /git/add`
暂存文件到索引

**请求参数**:
```typescript
interface GitAddRequest {
  repoPath: string;
  files: string[];               // 文件路径数组,空数组表示add .
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: {
    stagedFiles: string[];
  };
  error?: string;
}
```

**示例**:
```typescript
// 暂存特定文件
await window.electron.ipcRenderer.invoke('git:add', {
  repoPath: '/Users/laowang/repos/my-project',
  files: ['src/main.ts', 'package.json']
});

// 暂存所有文件
await window.electron.ipcRenderer.invoke('git:add', {
  repoPath: '/Users/laowang/repos/my-project',
  files: []  // 空数组 = git add .
});
```

---

### 2.4 取消暂存接口

#### `POST /git/reset`
从暂存区移除文件

**请求参数**:
```typescript
interface GitResetRequest {
  repoPath: string;
  files: string[];               // 文件路径数组
  mode?: 'soft' | 'mixed' | 'hard';  // 重置模式
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

**示例**:
```typescript
await window.electron.ipcRenderer.invoke('git:reset', {
  repoPath: '/Users/laowang/repos/my-project',
  files: ['src/main.ts'],
  mode: 'mixed'  // 默认模式
});
```

---

### 2.5 提交接口

#### `POST /git/commit`
创建提交

**请求参数**:
```typescript
interface GitCommitRequest {
  repoPath: string;
  message: string;               // 提交信息
  description?: string;          // 详细描述
  amend?: boolean;               // 是否修改上次提交
  author?: {
    name: string;
    email: string;
  };
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: {
    hash: string;
    summary: string;
  };
  error?: string;
}
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('git:commit', {
  repoPath: '/Users/laowang/repos/my-project',
  message: 'feat: 添加用户登录功能',
  description: '实现了用户名密码登录\n支持记住密码功能',
});

console.log(`提交成功: ${result.data.hash}`);
```

---

### 2.6 推送接口

#### `POST /git/push`
推送到远程仓库

**请求参数**:
```typescript
interface GitPushRequest {
  repoPath: string;
  remote?: string;               // 远程名,默认origin
  branch?: string;               // 分支名,默认当前分支
  force?: boolean;               // 是否强制推送
  auth?: {
    username?: string;
    password?: string;
    privateKeyPath?: string;
  };
}
```

**返回数据**:
```typescript
interface PushProgress {
  phase: 'counting' | 'compressing' | 'writing' | 'done';
  processed: number;
  total: number;
  percent: number;
}

interface Response {
  success: boolean;
  data?: {
    pushed: number;              // 推送的提交数
    remote: string;
    branch: string;
  };
  error?: string;
}
```

**进度回调**:
```typescript
window.electron.ipcRenderer.on('git:push:progress', (event, progress: PushProgress) => {
  console.log(`推送进度: ${progress.percent}%`);
});
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('git:push', {
  repoPath: '/Users/laowang/repos/my-project',
  remote: 'origin',
  branch: 'main',
  force: false,  // 艹,千万别乱用force!
});
```

---

### 2.7 拉取接口

#### `POST /git/pull`
从远程拉取更新

**请求参数**:
```typescript
interface GitPullRequest {
  repoPath: string;
  remote?: string;
  branch?: string;
  rebase?: boolean;              // 是否使用rebase
  auth?: {
    username?: string;
    password?: string;
    privateKeyPath?: string;
  };
}
```

**返回数据**:
```typescript
interface PullResult {
  files: string[];               // 更新的文件
  insertions: number;
  deletions: number;
  summary: {
    changes: number;
    insertions: number;
    deletions: number;
  };
}

interface Response {
  success: boolean;
  data?: PullResult;
  error?: string;
}
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('git:pull', {
  repoPath: '/Users/laowang/repos/my-project',
  rebase: true,  // 使用rebase保持历史清爽
});
```

---

## 三、分支管理模块 (Branch Management)

### 3.1 分支列表接口

#### `GET /git/branch/list`
获取所有分支

**请求参数**:
```typescript
interface BranchListRequest {
  repoPath: string;
  remote?: boolean;              // 是否包含远程分支
}
```

**返回数据**:
```typescript
interface Branch {
  name: string;                  // 分支名
  current: boolean;              // 是否当前分支
  remote: string | null;         // 远程分支名
  commit: {
    hash: string;
    message: string;
    author: string;
    date: string;
  };
  ahead: number;                 // 领先提交数
  behind: number;                // 落后提交数
}

interface Response {
  success: boolean;
  data?: {
    branches: Branch[];
    current: string;
  };
  error?: string;
}
```

**示例**:
```typescript
const { branches, current } = await window.electron.ipcRenderer.invoke('git:branch:list', {
  repoPath: '/Users/laowang/repos/my-project',
  remote: true,
});

console.log(`当前分支: ${current}`);
branches.forEach(b => {
  console.log(`${b.name} - ${b.commit.message}`);
});
```

---

### 3.2 创建分支接口

#### `POST /git/branch/create`
创建新分支

**请求参数**:
```typescript
interface CreateBranchRequest {
  repoPath: string;
  name: string;                  // 新分支名
  startPoint?: string;           // 起始点(提交哈希/分支名/标签)
  checkout?: boolean;            // 是否立即切换
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: {
    name: string;
    hash: string;
  };
  error?: string;
}
```

**示例**:
```typescript
await window.electron.ipcRenderer.invoke('git:branch:create', {
  repoPath: '/Users/laowang/repos/my-project',
  name: 'feature/user-login',
  startPoint: 'main',
  checkout: true,  // 创建并切换
});
```

---

### 3.3 切换分支接口

#### `POST /git/branch/checkout`
切换分支

**请求参数**:
```typescript
interface CheckoutBranchRequest {
  repoPath: string;
  name: string;                  // 分支名
  create?: boolean;              // 如果不存在是否创建
  force?: boolean;               // 是否强制切换(丢弃本地修改)
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: {
    from: string;
    to: string;
  };
  error?: string;
}
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('git:branch:checkout', {
  repoPath: '/Users/laowang/repos/my-project',
  name: 'develop',
  force: false,  // 艹,有未提交修改不能切换!
});
```

---

### 3.4 删除分支接口

#### `DELETE /git/branch/:name`
删除分支

**请求参数**:
```typescript
interface DeleteBranchRequest {
  repoPath: string;
  name: string;                  // 分支名
  force?: boolean;               // 是否强制删除
  remote?: boolean;              // 是否删除远程分支
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

**示例**:
```typescript
// 删除本地分支
await window.electron.ipcRenderer.invoke('git:branch:delete', {
  repoPath: '/Users/laowang/repos/my-project',
  name: 'feature/old-feature',
  force: false,
});

// 删除远程分支
await window.electron.ipcRenderer.invoke('git:branch:delete', {
  repoPath: '/Users/laowang/repos/my-project',
  name: 'feature/old-feature',
  remote: true,
});
```

---

### 3.5 合并分支接口

#### `POST /git/branch/merge`
合并分支

**请求参数**:
```typescript
interface MergeBranchRequest {
  repoPath: string;
  source: string;                // 源分支
  target?: string;               // 目标分支,默认当前分支
  noFf?: boolean;                // 是否禁用fast-forward
  squash?: boolean;              // 是否压缩提交
}
```

**返回数据**:
```typescript
interface MergeResult {
  success: boolean;
  conflicts: string[];           // 冲突文件列表
  merged: boolean;
  hash?: string;
}

interface Response {
  success: boolean;
  data?: MergeResult;
  error?: string;
}
```

**示例**:
```typescript
const result = await window.electron.ipcRenderer.invoke('git:branch:merge', {
  repoPath: '/Users/laowang/repos/my-project',
  source: 'feature/new-feature',
  target: 'develop',
  noFf: true,  // 保留分支历史
});

if (result.data.conflicts.length > 0) {
  console.log('艹,有冲突需要解决!');
  console.log(result.data.conflicts);
}
```

---

## 四、差异对比模块 (Diff & Merge)

### 4.1 文件差异接口

#### `GET /git/diff`
获取文件差异

**请求参数**:
```typescript
interface GitDiffRequest {
  repoPath: string;
  file?: string;                 // 特定文件,为空则所有文件
  cached?: boolean;              // 查看暂存区差异
  base?: string;                 // 基准点(提交哈希/分支)
  target?: string;               // 对比点
}
```

**返回数据**:
```typescript
interface DiffHunk {
  oldStart: number;
  oldLines: number;
  newStart: number;
  newLines: number;
  lines: Array<{
    type: 'add' | 'delete' | 'normal';
    content: string;
    oldLine?: number;
    newLine?: number;
  }>;
}

interface FileDiff {
  path: string;
  oldPath?: string;              // 重命名前路径
  type: 'add' | 'modify' | 'delete' | 'rename';
  hunks: DiffHunk[];
  stats: {
    additions: number;
    deletions: number;
  };
}

interface Response {
  success: boolean;
  data?: {
    files: FileDiff[];
    stats: {
      files: number;
      additions: number;
      deletions: number;
    };
  };
  error?: string;
}
```

**示例**:
```typescript
const diff = await window.electron.ipcRenderer.invoke('git:diff', {
  repoPath: '/Users/laowang/repos/my-project',
  file: 'src/main.ts',
  cached: true,  // 查看暂存区的diff
});
```

---

### 4.2 冲突文件接口

#### `GET /git/conflicts`
获取冲突文件内容

**请求参数**:
```typescript
interface ConflictsRequest {
  repoPath: string;
}
```

**返回数据**:
```typescript
interface ConflictFile {
  path: string;
  ours: string;                  // 当前分支内容
  theirs: string;                // 合并分支内容
  base: string;                  // 共同祖先内容
  current: string;               // 当前文件内容(包含冲突标记)
  markers: Array<{
    start: number;
    middle: number;
    end: number;
  }>;
}

interface Response {
  success: boolean;
  data?: {
    files: ConflictFile[];
  };
  error?: string;
}
```

**示例**:
```typescript
const { files } = await window.electron.ipcRenderer.invoke('git:conflicts', {
  repoPath: '/Users/laowang/repos/my-project',
});

files.forEach(file => {
  console.log(`冲突文件: ${file.path}`);
});
```

---

### 4.3 解决冲突接口

#### `POST /git/resolve`
标记冲突已解决

**请求参数**:
```typescript
interface ResolveConflictRequest {
  repoPath: string;
  file: string;                  // 文件路径
  content: string;               // 解决后的内容
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

**示例**:
```typescript
await window.electron.ipcRenderer.invoke('git:resolve', {
  repoPath: '/Users/laowang/repos/my-project',
  file: 'src/main.ts',
  content: mergedContent,  // 用户编辑后的内容
});
```

---

## 五、标签管理模块 (Tag Management)

### 5.1 标签列表接口

#### `GET /git/tag/list`
获取所有标签

**请求参数**:
```typescript
interface TagListRequest {
  repoPath: string;
}
```

**返回数据**:
```typescript
interface Tag {
  name: string;
  hash: string;
  message: string;
  taggerName: string;
  taggerEmail: string;
  date: string;
}

interface Response {
  success: boolean;
  data?: {
    tags: Tag[];
  };
  error?: string;
}
```

---

### 5.2 创建标签接口

#### `POST /git/tag/create`
创建新标签

**请求参数**:
```typescript
interface CreateTagRequest {
  repoPath: string;
  name: string;                  // 标签名
  message?: string;              // 标签信息(annotated tag)
  target?: string;               // 目标提交,默认HEAD
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  data?: {
    name: string;
    hash: string;
  };
  error?: string;
}
```

**示例**:
```typescript
await window.electron.ipcRenderer.invoke('git:tag:create', {
  repoPath: '/Users/laowang/repos/my-project',
  name: 'v1.0.0',
  message: '正式发布v1.0.0版本',
});
```

---

## 六、远程仓库模块 (Remote Management)

### 6.1 远程列表接口

#### `GET /git/remote/list`
获取远程仓库列表

**请求参数**:
```typescript
interface RemoteListRequest {
  repoPath: string;
}
```

**返回数据**:
```typescript
interface Remote {
  name: string;
  fetchUrl: string;
  pushUrl: string;
}

interface Response {
  success: boolean;
  data?: {
    remotes: Remote[];
  };
  error?: string;
}
```

---

### 6.2 添加远程仓库接口

#### `POST /git/remote/add`
添加远程仓库

**请求参数**:
```typescript
interface AddRemoteRequest {
  repoPath: string;
  name: string;                  // 远程名
  url: string;                   // 远程地址
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

---

### 6.3 删除远程仓库接口

#### `DELETE /git/remote/:name`
删除远程仓库

**请求参数**:
```typescript
interface RemoveRemoteRequest {
  repoPath: string;
  name: string;
}
```

**返回数据**:
```typescript
interface Response {
  success: boolean;
  error?: string;
}
```

---

## 七、总结

**艹,这些接口定义得清清楚楚!**

核心要点:
1. ✅ 所有接口都是Promise based的
2. ✅ 统一的错误处理机制
3. ✅ 完整的TypeScript类型定义
4. ✅ 支持进度回调(克隆/推送/拉取)
5. ✅ 覆盖Ugit的所有核心功能

接下来实现这些接口的时候,必须严格按照这个规范来,不能乱搞!

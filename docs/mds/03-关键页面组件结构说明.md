# 关键页面组件结构说明

> 作者:老王  
> 日期:2025-11-30  
> 版本:v1.0

**艹,UI组件必须按照设计图100%还原,一个像素都不能差!**

---

## 一、整体布局结构

### 1.1 应用主框架

```
┌────────────────────────────────────────────────┐
│             Title Bar (自定义标题栏)              │
├──────────┬─────────────────────────────────────┤
│          │                                     │
│          │                                     │
│ Sidebar  │         Main Content Area           │
│          │                                     │
│          │                                     │
│          │                                     │
├──────────┴─────────────────────────────────────┤
│             Status Bar (底部状态栏)              │
└────────────────────────────────────────────────┘
```

### 1.2 主布局组件

**文件**: `src/renderer/components/Layout/MainLayout.tsx`

```typescript
import { useReactive } from 'ahooks';
import { Outlet } from 'react-router-dom';
import Sidebar from '../Sidebar';
import TitleBar from '../TitleBar';
import StatusBar from '../StatusBar';

/**
 * 主布局组件
 * 艹,这是整个应用的骨架,别tm乱动!
 */
export const MainLayout = () => {
  const state = useReactive({
    sidebarCollapsed: false,
  });

  return (
    <div className="h-screen flex flex-col bg-gray-50">
      {/* 自定义标题栏 */}
      <TitleBar />
      
      <div className="flex flex-1 overflow-hidden">
        {/* 左侧边栏 */}
        <Sidebar 
          collapsed={state.sidebarCollapsed}
          onToggle={() => state.sidebarCollapsed = !state.sidebarCollapsed}
        />
        
        {/* 主内容区 */}
        <main className="flex-1 overflow-auto">
          <Outlet />
        </main>
      </div>
      
      {/* 底部状态栏 */}
      <StatusBar />
    </div>
  );
};
```

---

## 二、核心页面组件

### 2.1 首页/仓库列表页

**文件**: `src/renderer/pages/Home/index.tsx`

**设计图参考**: `/imgs/初始化.png`

**布局结构**:
```
┌────────────────────────────────────────────┐
│  [仓库]                            [+]     │
├────────────────────────────────────────────┤
│                                            │
│              Git Clone                     │
│                                            │
│  ┌──────────────────────────────────────┐ │
│  │ 输入仓库URL                            │ │
│  └──────────────────────────────────────┘ │
│                                            │
│           [Clone]                          │
│                                            │
└────────────────────────────────────────────┘
```

**组件代码**:
```typescript
import { useReactive, useMemoizedFn } from 'ahooks';
import { useRepoStore } from '@/store/repo.store';

/**
 * 首页组件
 * 艹,这是用户看到的第一个界面,必须简洁明了!
 */
export const HomePage = () => {
  const repoStore = useRepoStore();
  
  const state = useReactive({
    cloneUrl: '',
    targetPath: '',
    isCloning: false,
    progress: 0,
  });

  // 选择目标路径
  const selectTargetPath = useMemoizedFn(async () => {
    const result = await window.electron.ipcRenderer.invoke('dialog:open-directory');
    if (result) {
      state.targetPath = result;
    }
  });

  // 克隆仓库
  const handleClone = useMemoizedFn(async () => {
    if (!state.cloneUrl || !state.targetPath) {
      // 艹,必填项没填!
      return;
    }

    state.isCloning = true;
    
    try {
      // 监听克隆进度
      window.electron.ipcRenderer.on('repo:clone:progress', (_, progress) => {
        state.progress = progress.percent;
      });

      await window.electron.ipcRenderer.invoke('repo:clone', {
        url: state.cloneUrl,
        targetPath: state.targetPath,
      });

      // 克隆成功,跳转到仓库页面
      // ...
    } catch (error) {
      console.error('克隆失败:', error);
    } finally {
      state.isCloning = false;
    }
  });

  return (
    <div className="h-full flex flex-col">
      {/* 顶部操作栏 */}
      <div className="flex items-center justify-between p-4 border-b">
        <span className="text-lg font-semibold">仓库</span>
        <button 
          className="w-8 h-8 rounded hover:bg-gray-200 flex items-center justify-center"
          onClick={() => {/* 添加现有仓库 */}}
        >
          <PlusIcon className="w-5 h-5" />
        </button>
      </div>

      {/* 主内容区 */}
      <div className="flex-1 flex items-center justify-center">
        <div className="w-full max-w-md space-y-6">
          <h2 className="text-2xl font-bold text-center">Git Clone</h2>
          
          {/* URL输入框 */}
          <div className="space-y-2">
            <input
              type="text"
              placeholder="输入仓库URL"
              value={state.cloneUrl}
              onChange={e => state.cloneUrl = e.target.value}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>

          {/* 目标路径 */}
          <div className="space-y-2">
            <div className="flex gap-2">
              <input
                type="text"
                placeholder="选择目标路径"
                value={state.targetPath}
                readOnly
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-gray-50"
              />
              <button
                onClick={selectTargetPath}
                className="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg"
              >
                浏览
              </button>
            </div>
          </div>

          {/* 克隆按钮 */}
          <button
            onClick={handleClone}
            disabled={state.isCloning || !state.cloneUrl || !state.targetPath}
            className="w-full py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
          >
            {state.isCloning ? `克隆中... ${state.progress}%` : 'Clone'}
          </button>
        </div>
      </div>
    </div>
  );
};
```

---

### 2.2 仓库详情页

**文件**: `src/renderer/pages/Repository/index.tsx`

**布局结构**:
```
┌────────────────────────────────────────────────────────┐
│  [提交历史] [分支] [变更] [暂存区]                        │
├────────────────────────────────────────────────────────┤
│                                                        │
│                  (根据选中Tab显示对应内容)                │
│                                                        │
└────────────────────────────────────────────────────────┘
```

**组件代码**:
```typescript
import { useReactive, useMemoizedFn } from 'ahooks';
import { useParams } from 'react-router-dom';
import { Tabs } from '@/components/Tabs';
import CommitsTab from './Commits';
import BranchesTab from './Branches';
import ChangesTab from './Changes';
import StagingTab from './Staging';

export const RepositoryPage = () => {
  const { repoId } = useParams();
  
  const state = useReactive({
    activeTab: 'commits', // commits | branches | changes | staging
  });

  const tabs = [
    { key: 'commits', label: '提交历史', component: CommitsTab },
    { key: 'branches', label: '分支', component: BranchesTab },
    { key: 'changes', label: '变更', component: ChangesTab },
    { key: 'staging', label: '暂存区', component: StagingTab },
  ];

  return (
    <div className="h-full flex flex-col">
      {/* Tab导航 */}
      <Tabs
        tabs={tabs}
        activeTab={state.activeTab}
        onChange={tab => state.activeTab = tab}
      />

      {/* Tab内容 */}
      <div className="flex-1 overflow-hidden">
        {tabs.find(t => t.key === state.activeTab)?.component}
      </div>
    </div>
  );
};
```

---

### 2.3 提交历史Tab

**文件**: `src/renderer/pages/Repository/Commits/index.tsx`

**功能要求**:
- 虚拟滚动列表(性能优化)
- 提交图表展示(分支合并关系)
- 提交详情查看
- Cherry-pick功能

**组件代码**:
```typescript
import { useReactive, useMemoizedFn, useMount } from 'ahooks';
import { useVirtualizer } from '@tanstack/react-virtual';
import { useParams } from 'react-router-dom';
import CommitGraph from '@/components/CommitGraph';
import CommitDetail from './CommitDetail';

export const CommitsTab = () => {
  const { repoId } = useParams();
  const parentRef = useRef<HTMLDivElement>(null);
  
  const state = useReactive({
    commits: [] as Commit[],
    selectedCommit: null as Commit | null,
    isLoading: false,
    hasMore: true,
  });

  // 加载提交历史
  const loadCommits = useMemoizedFn(async (append = false) => {
    if (state.isLoading || !state.hasMore) return;

    state.isLoading = true;
    try {
      const result = await window.electron.ipcRenderer.invoke('git:log', {
        repoPath: repoId,
        options: {
          maxCount: 50,
          skip: append ? state.commits.length : 0,
        },
      });

      if (append) {
        state.commits.push(...result.data.commits);
      } else {
        state.commits = result.data.commits;
      }
      
      state.hasMore = result.data.hasMore;
    } catch (error) {
      console.error('加载提交历史失败:', error);
    } finally {
      state.isLoading = false;
    }
  });

  useMount(() => {
    loadCommits();
  });

  // 虚拟滚动
  const rowVirtualizer = useVirtualizer({
    count: state.commits.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 72,
    overscan: 10,
  });

  // 滚动到底部加载更多
  useEffect(() => {
    const lastItem = rowVirtualizer.getVirtualItems().at(-1);
    if (
      lastItem &&
      lastItem.index >= state.commits.length - 1 &&
      state.hasMore &&
      !state.isLoading
    ) {
      loadCommits(true);
    }
  }, [rowVirtualizer.getVirtualItems()]);

  return (
    <div className="h-full flex">
      {/* 左侧:提交列表 */}
      <div className="w-1/2 border-r flex flex-col">
        {/* 工具栏 */}
        <div className="p-4 border-b flex gap-2">
          <input
            type="text"
            placeholder="搜索提交..."
            className="flex-1 px-3 py-2 border rounded"
          />
          <button className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            刷新
          </button>
        </div>

        {/* 提交列表(虚拟滚动) */}
        <div ref={parentRef} className="flex-1 overflow-auto">
          <div
            style={{
              height: `${rowVirtualizer.getTotalSize()}px`,
              position: 'relative',
            }}
          >
            {rowVirtualizer.getVirtualItems().map(virtualRow => {
              const commit = state.commits[virtualRow.index];
              return (
                <div
                  key={commit.hash}
                  style={{
                    position: 'absolute',
                    top: 0,
                    left: 0,
                    width: '100%',
                    height: `${virtualRow.size}px`,
                    transform: `translateY(${virtualRow.start}px)`,
                  }}
                  onClick={() => state.selectedCommit = commit}
                  className={`
                    p-4 border-b cursor-pointer hover:bg-gray-50
                    ${state.selectedCommit?.hash === commit.hash ? 'bg-blue-50' : ''}
                  `}
                >
                  <div className="flex items-start gap-3">
                    {/* 提交图表 */}
                    <CommitGraph commit={commit} />
                    
                    {/* 提交信息 */}
                    <div className="flex-1 min-w-0">
                      <div className="font-semibold truncate">{commit.message}</div>
                      <div className="text-sm text-gray-500 mt-1">
                        <span>{commit.author.name}</span>
                        <span className="mx-2">·</span>
                        <span>{formatDate(commit.date)}</span>
                        <span className="mx-2">·</span>
                        <span className="font-mono text-xs">{commit.shortHash}</span>
                      </div>
                    </div>

                    {/* 操作按钮 */}
                    <div className="flex gap-1">
                      <button
                        className="p-2 hover:bg-gray-200 rounded"
                        title="Cherry-pick"
                      >
                        <CherryPickIcon className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        {/* 加载更多指示器 */}
        {state.isLoading && (
          <div className="p-4 text-center text-gray-500">
            加载中...
          </div>
        )}
      </div>

      {/* 右侧:提交详情 */}
      <div className="flex-1">
        {state.selectedCommit ? (
          <CommitDetail commit={state.selectedCommit} />
        ) : (
          <div className="h-full flex items-center justify-center text-gray-400">
            选择一个提交查看详情
          </div>
        )}
      </div>
    </div>
  );
};
```

---

### 2.4 分支管理Tab

**文件**: `src/renderer/pages/Repository/Branches/index.tsx`

**功能要求**:
- 本地分支列表
- 远程分支列表
- 创建/删除/切换分支
- 合并分支
- 推送/拉取分支

**组件代码**:
```typescript
import { useReactive, useMemoizedFn, useMount } from 'ahooks';
import { useParams } from 'react-router-dom';

export const BranchesTab = () => {
  const { repoId } = useParams();
  
  const state = useReactive({
    branches: [] as Branch[],
    currentBranch: '',
    filter: 'all', // all | local | remote
    showCreateModal: false,
  });

  // 加载分支列表
  const loadBranches = useMemoizedFn(async () => {
    const result = await window.electron.ipcRenderer.invoke('git:branch:list', {
      repoPath: repoId,
      remote: true,
    });
    
    state.branches = result.data.branches;
    state.currentBranch = result.data.current;
  });

  useMount(() => {
    loadBranches();
  });

  // 切换分支
  const checkoutBranch = useMemoizedFn(async (branchName: string) => {
    try {
      await window.electron.ipcRenderer.invoke('git:branch:checkout', {
        repoPath: repoId,
        name: branchName,
      });
      
      await loadBranches();
    } catch (error) {
      console.error('切换分支失败:', error);
    }
  });

  // 删除分支
  const deleteBranch = useMemoizedFn(async (branchName: string) => {
    // 艹,删除分支要确认!
    const confirmed = await window.electron.ipcRenderer.invoke('dialog:confirm', {
      title: '删除分支',
      message: `确定要删除分支 ${branchName} 吗?`,
    });

    if (!confirmed) return;

    try {
      await window.electron.ipcRenderer.invoke('git:branch:delete', {
        repoPath: repoId,
        name: branchName,
      });
      
      await loadBranches();
    } catch (error) {
      console.error('删除分支失败:', error);
    }
  });

  const filteredBranches = state.branches.filter(b => {
    if (state.filter === 'local') return !b.remote;
    if (state.filter === 'remote') return b.remote;
    return true;
  });

  return (
    <div className="h-full flex flex-col">
      {/* 工具栏 */}
      <div className="p-4 border-b space-y-3">
        {/* 过滤器 */}
        <div className="flex gap-2">
          <button
            onClick={() => state.filter = 'all'}
            className={`px-3 py-1 rounded ${state.filter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
          >
            全部
          </button>
          <button
            onClick={() => state.filter = 'local'}
            className={`px-3 py-1 rounded ${state.filter === 'local' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
          >
            本地
          </button>
          <button
            onClick={() => state.filter = 'remote'}
            className={`px-3 py-1 rounded ${state.filter === 'remote' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
          >
            远程
          </button>
        </div>

        {/* 操作按钮 */}
        <div className="flex gap-2">
          <button
            onClick={() => state.showCreateModal = true}
            className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
          >
            新建分支
          </button>
          <button
            onClick={loadBranches}
            className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >
            刷新
          </button>
        </div>
      </div>

      {/* 分支列表 */}
      <div className="flex-1 overflow-auto">
        {filteredBranches.map(branch => (
          <div
            key={branch.name}
            className={`
              p-4 border-b hover:bg-gray-50
              ${branch.current ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}
            `}
          >
            <div className="flex items-center justify-between">
              {/* 分支信息 */}
              <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                  <span className="font-semibold">{branch.name}</span>
                  {branch.current && (
                    <span className="px-2 py-0.5 text-xs bg-blue-500 text-white rounded">
                      当前
                    </span>
                  )}
                  {branch.remote && (
                    <span className="px-2 py-0.5 text-xs bg-gray-300 rounded">
                      远程
                    </span>
                  )}
                </div>
                
                <div className="text-sm text-gray-500 mt-1 truncate">
                  {branch.commit.message}
                </div>
                
                {branch.ahead > 0 || branch.behind > 0 && (
                  <div className="text-xs text-gray-400 mt-1">
                    {branch.ahead > 0 && `领先 ${branch.ahead} 个提交`}
                    {branch.behind > 0 && `落后 ${branch.behind} 个提交`}
                  </div>
                )}
              </div>

              {/* 操作按钮 */}
              <div className="flex gap-2">
                {!branch.current && !branch.remote && (
                  <button
                    onClick={() => checkoutBranch(branch.name)}
                    className="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    切换
                  </button>
                )}
                
                {!branch.current && (
                  <button
                    onClick={() => deleteBranch(branch.name)}
                    className="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600"
                  >
                    删除
                  </button>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
```

---

### 2.5 文件变更Tab

**文件**: `src/renderer/pages/Repository/Changes/index.tsx`

**功能要求**:
- 未暂存文件列表
- 已暂存文件列表
- 拖拽暂存/取消暂存
- Diff查看
- 提交功能

---

### 2.6 冲突合并页面

**文件**: `src/renderer/pages/Repository/Merge/index.tsx`

**功能要求**:
- 三栏对比视图(Ours | Merged | Theirs)
- 冲突块高亮
- 选择保留哪一方的修改
- 手动编辑合并结果
- 标记冲突已解决

**组件代码**:
```typescript
import { useReactive, useMemoizedFn } from 'ahooks';
import Editor from '@monaco-editor/react';

export const MergePage = () => {
  const state = useReactive({
    conflicts: [] as ConflictFile[],
    currentFile: null as ConflictFile | null,
    mergedContent: '',
  });

  // 选择Ours
  const chooseOurs = useMemoizedFn(() => {
    if (!state.currentFile) return;
    state.mergedContent = state.currentFile.ours;
  });

  // 选择Theirs
  const chooseTheirs = useMemoizedFn(() => {
    if (!state.currentFile) return;
    state.mergedContent = state.currentFile.theirs;
  });

  // 保存并标记已解决
  const resolveConflict = useMemoizedFn(async () => {
    if (!state.currentFile) return;

    await window.electron.ipcRenderer.invoke('git:resolve', {
      repoPath: repoId,
      file: state.currentFile.path,
      content: state.mergedContent,
    });

    // 移到下一个冲突文件
    // ...
  });

  return (
    <div className="h-full flex flex-col">
      {/* 顶部工具栏 */}
      <div className="p-4 border-b flex justify-between">
        <span className="text-lg font-semibold">
          冲突合并 - {state.currentFile?.path}
        </span>
        
        <div className="flex gap-2">
          <button
            onClick={chooseOurs}
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >
            使用当前分支
          </button>
          <button
            onClick={chooseTheirs}
            className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
          >
            使用合并分支
          </button>
          <button
            onClick={resolveConflict}
            className="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600"
          >
            标记已解决
          </button>
        </div>
      </div>

      {/* 三栏对比 */}
      <div className="flex-1 grid grid-cols-3 gap-2 p-2">
        {/* Ours */}
        <div className="flex flex-col">
          <div className="p-2 bg-blue-100 border-b">
            当前分支 (Ours)
          </div>
          <Editor
            value={state.currentFile?.ours}
            options={{ readOnly: true }}
            theme="vs-light"
          />
        </div>

        {/* Merged */}
        <div className="flex flex-col">
          <div className="p-2 bg-purple-100 border-b">
            合并结果
          </div>
          <Editor
            value={state.mergedContent}
            onChange={value => state.mergedContent = value || ''}
            theme="vs-light"
          />
        </div>

        {/* Theirs */}
        <div className="flex flex-col">
          <div className="p-2 bg-green-100 border-b">
            合并分支 (Theirs)
          </div>
          <Editor
            value={state.currentFile?.theirs}
            options={{ readOnly: true }}
            theme="vs-light"
          />
        </div>
      </div>
    </div>
  );
};
```

---

## 三、通用组件库

### 3.1 文件树组件

**文件**: `src/renderer/components/FileTree/index.tsx`

**功能**:
- 递归渲染文件树
- 折叠/展开目录
- 文件图标
- 拖拽功能

---

### 3.2 Diff查看器

**文件**: `src/renderer/components/DiffViewer/index.tsx`

**功能**:
- 行内Diff显示
- 语法高亮
- 展开/折叠未变更部分
- 并排对比模式

---

### 3.3 提交图表

**文件**: `src/renderer/components/CommitGraph/index.tsx`

**功能**:
- Canvas绘制分支树
- 分支合并关系可视化
- 颜色区分不同分支

---

## 四、样式规范

### 4.1 TailwindCSS配置

**文件**: `tailwind.config.js`

```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/renderer/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#eff6ff',
          100: '#dbeafe',
          // ... 其他色值
          500: '#3b82f6',
          600: '#2563eb',
        },
      },
    },
  },
  plugins: [],
};
```

### 4.2 主题色彩

- **主色**: 蓝色 (#3b82f6)
- **成功**: 绿色 (#10b981)
- **警告**: 黄色 (#f59e0b)
- **危险**: 红色 (#ef4444)
- **中性**: 灰色系

### 4.3 通用样式类

```css
/* 艹,这些是常用的工具类,必须定义! */

/* 按钮 */
.btn {
  @apply px-4 py-2 rounded font-semibold transition-colors;
}

.btn-primary {
  @apply bg-blue-500 text-white hover:bg-blue-600;
}

.btn-secondary {
  @apply bg-gray-200 hover:bg-gray-300;
}

/* 输入框 */
.input {
  @apply px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500;
}

/* 卡片 */
.card {
  @apply bg-white rounded-lg shadow p-4;
}
```

---

## 五、交互规范

### 5.1 加载状态
- 使用Loading组件显示加载中
- 禁用相关操作按钮
- 显示进度条(如果有进度信息)

### 5.2 错误处理
- Toast提示错误信息
- 表单验证错误标红
- 提供重试按钮

### 5.3 确认操作
- 危险操作(删除/强制推送)必须二次确认
- 使用Modal对话框

---

## 六、性能优化

### 6.1 虚拟滚动
大列表(>100项)必须使用虚拟滚动

### 6.2 懒加载
- 图片懒加载
- 路由懒加载
- 组件懒加载

### 6.3 防抖节流
- 搜索输入防抖(300ms)
- 滚动事件节流(100ms)

---

## 七、总结

**艹,这个组件结构清清楚楚,严格按照这个来实现!**

核心要点:
1. ✅ 100%还原设计图
2. ✅ 使用ahooks的useReactive管理状态
3. ✅ 使用useMemoizedFn优化函数
4. ✅ 虚拟滚动提升性能
5. ✅ TailwindCSS统一样式
6. ✅ 原子化组件设计

**接下来实现的时候,每个像素都要对齐设计图!**

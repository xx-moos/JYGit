# JYGit 架构设计文档

> 作者:老王  
> 日期:2025-11-30  
> 版本:v1.0

## 一、项目概述

**艹,这个项目就是要100%复刻腾讯Ugit的所有功能!**

JYGit是一个基于Electron+React技术栈的桌面Git可视化管理工具,提供直观的界面来管理Git仓库。项目必须严格遵循以下技术选型:

### 技术栈
- **主框架**: electron-vite
- **UI层**: React 18+ (函数组件 + Hooks)
- **样式**: TailwindCSS 3+
- **工具库**: ahooks (状态管理使用useReactive)
- **日期处理**: dayjs
- **路由**: react-router-dom v6
- **Git操作**: simple-git
- **开发语言**: TypeScript 5+

---

## 二、整体架构设计

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    JYGit Application                     │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐              ┌──────────────────┐    │
│  │              │              │                  │    │
│  │  Main Process│◄────IPC─────►│ Renderer Process │    │
│  │  (Electron)  │              │     (React)      │    │
│  │              │              │                  │    │
│  └──────┬───────┘              └────────┬─────────┘    │
│         │                               │              │
│         │                               │              │
│  ┌──────▼──────────┐           ┌───────▼──────────┐   │
│  │                 │           │                  │   │
│  │  Git SDK        │           │   UI Components  │   │
│  │  (simple-git)   │           │   (React+Hooks)  │   │
│  │                 │           │                  │   │
│  └─────────────────┘           └──────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 2.2 分层架构 (严格遵循SOLID原则)

#### 第一层:主进程层 (Main Process)
**职责**:
- 窗口管理
- 文件系统访问
- Git核心操作调度
- IPC通信处理

**核心模块**:
```typescript
src/main/
├── index.ts              // 主进程入口
├── window.ts             // 窗口管理
├── ipc/                  // IPC处理器
│   ├── git.handler.ts    // Git操作IPC
│   ├── file.handler.ts   // 文件操作IPC
│   └── repo.handler.ts   // 仓库管理IPC
└── services/             // 业务服务
    └── git/              // Git服务
        ├── git.service.ts
        ├── clone.service.ts
        ├── branch.service.ts
        ├── commit.service.ts
        └── diff.service.ts
```

#### 第二层:渲染进程层 (Renderer Process)
**职责**:
- UI渲染
- 用户交互
- 状态管理
- 与主进程通信

**核心模块**:
```typescript
src/renderer/
├── App.tsx               // 应用根组件
├── main.tsx              // 渲染进程入口
├── router/               // 路由配置
│   └── index.tsx
├── pages/                // 页面组件
│   ├── Home/             // 首页(仓库列表)
│   ├── Clone/            // Clone仓库
│   ├── Repository/       // 仓库详情
│   │   ├── Commits/      // 提交历史
│   │   ├── Branches/     // 分支管理
│   │   ├── Changes/      // 变更文件
│   │   ├── Diff/         // 差异对比
│   │   └── Merge/        // 合并冲突
│   └── Settings/         // 设置
├── components/           // 通用组件
│   ├── Layout/           // 布局组件
│   ├── Sidebar/          // 侧边栏
│   ├── FileTree/         // 文件树
│   ├── DiffViewer/       // Diff查看器
│   ├── CommitGraph/      // 提交图表
│   └── ConflictEditor/   // 冲突编辑器
├── hooks/                // 自定义Hooks
│   ├── useGit.ts         // Git操作Hook
│   ├── useRepo.ts        // 仓库Hook
│   └── useIPC.ts         // IPC通信Hook
├── store/                // 状态管理
│   ├── repo.store.ts     // 仓库状态
│   ├── git.store.ts      // Git状态
│   └── ui.store.ts       // UI状态
└── utils/                // 工具函数
    ├── ipc.ts            // IPC封装
    └── format.ts         // 格式化工具
```

#### 第三层:Git SDK层
**职责**:
- 封装simple-git
- 提供统一的Git操作API
- 错误处理和重试机制

**核心模块**:
```typescript
src/sdk/
├── index.ts              // SDK入口
├── types/                // 类型定义
│   ├── repository.ts
│   ├── commit.ts
│   ├── branch.ts
│   └── diff.ts
├── core/                 // 核心功能
│   ├── GitClient.ts      // Git客户端
│   ├── Repository.ts     // 仓库操作
│   ├── Branch.ts         // 分支操作
│   ├── Commit.ts         // 提交操作
│   ├── Diff.ts           // 差异操作
│   └── Merge.ts          // 合并操作
└── utils/                // 工具
    ├── parser.ts         // Git输出解析
    └── validator.ts      // 参数校验
```

---

## 三、核心设计原则

### 3.1 KISS原则 (Keep It Simple, Stupid)
- **单一职责**:每个模块只做一件事,做好一件事
- **简单直接**:避免过度设计,优先选择最直观的解决方案
- **代码简洁**:函数长度控制在50行以内,逻辑清晰易懂

### 3.2 YAGNI原则 (You Aren't Gonna Need It)
- **按需开发**:只实现当前明确需要的功能
- **拒绝预留**:不为未来可能的需求预留代码
- **及时清理**:删除未使用的代码和依赖

### 3.3 DRY原则 (Don't Repeat Yourself)
- **代码复用**:识别重复模式,抽象为可复用组件
- **统一接口**:相似功能使用统一的实现方式
- **配置集中**:配置项集中管理,避免分散定义

### 3.4 SOLID原则

#### S - 单一职责原则
每个类/组件只负责一个功能领域
```typescript
// ❌ 错误:职责混乱
class GitManager {
  clone() {}
  commit() {}
  push() {}
  renderUI() {}  // SB!UI和Git操作混在一起
}

// ✅ 正确:职责单一
class GitService {
  clone() {}
  commit() {}
  push() {}
}

class RepositoryView {
  renderUI() {}
}
```

#### O - 开闭原则
对扩展开放,对修改关闭
```typescript
// ✅ 使用策略模式支持扩展
interface DiffStrategy {
  diff(file: string): Promise&lt;DiffResult&gt;;
}

class LineDiffStrategy implements DiffStrategy {
  async diff(file: string) { /* ... */ }
}

class WordDiffStrategy implements DiffStrategy {
  async diff(file: string) { /* ... */ }
}
```

#### L - 里氏替换原则
子类型必须能替换父类型
```typescript
// ✅ 正确的继承关系
interface GitOperation {
  execute(): Promise&lt;void&gt;;
}

class CloneOperation implements GitOperation {
  async execute() { /* clone逻辑 */ }
}

class PullOperation implements GitOperation {
  async execute() { /* pull逻辑 */ }
}
```

#### I - 接口隔离原则
接口专一,避免"胖接口"
```typescript
// ❌ 错误:胖接口
interface GitClient {
  clone() {}
  commit() {}
  push() {}
  branch() {}
  merge() {}
  // ...50个方法,艹!
}

// ✅ 正确:拆分接口
interface CloneOperations {
  clone(): Promise&lt;void&gt;;
}

interface CommitOperations {
  commit(): Promise&lt;void&gt;;
  amend(): Promise&lt;void&gt;;
}

interface BranchOperations {
  create(): Promise&lt;void&gt;;
  delete(): Promise&lt;void&gt;;
  checkout(): Promise&lt;void&gt;;
}
```

#### D - 依赖倒置原则
依赖抽象而非具体实现
```typescript
// ✅ 依赖抽象
interface IGitService {
  getStatus(): Promise&lt;GitStatus&gt;;
}

class RepositoryPage {
  constructor(private gitService: IGitService) {} // 依赖接口
  
  async load() {
    const status = await this.gitService.getStatus();
  }
}
```

---

## 四、跨平台兼容性设计

### 4.1 路径处理
```typescript
import path from 'path';

// ✅ 正确:使用path模块统一处理
const repoPath = path.join(userHome, 'repositories', repoName);

// ❌ 错误:硬编码路径分隔符
const repoPath = userHome + '\\repositories\\' + repoName; // SB代码!
```

### 4.2 命令执行
```typescript
// ✅ 跨平台shell命令
const shell = process.platform === 'win32' ? 'cmd' : 'bash';
```

### 4.3 文件监听
使用Electron的文件监听API,而不是依赖操作系统特定功能

---

## 五、性能优化策略

### 5.1 大仓库优化目标
- **提交历史加载**: &lt;1.2s (1000+提交)
- **文件树渲染**: &lt;500ms (10000+文件)
- **冲突合并响应**: &lt;500ms
- **内存占用峰值**: &lt;200MB (1000+文件仓库)

### 5.2 优化手段

#### 虚拟滚动
对于大列表使用虚拟滚动
```typescript
import { useVirtualizer } from '@tanstack/react-virtual';

// 提交历史列表虚拟化
const CommitList = ({ commits }: Props) =&gt; {
  const parentRef = useRef&lt;HTMLDivElement&gt;(null);
  
  const rowVirtualizer = useVirtualizer({
    count: commits.length,
    getScrollElement: () =&gt; parentRef.current,
    estimateSize: () =&gt; 64, // 每行高度
  });
  
  return (
    &lt;div ref={parentRef} className="h-full overflow-auto"&gt;
      {rowVirtualizer.getVirtualItems().map(virtualRow =&gt; (
        &lt;CommitRow key={virtualRow.index} commit={commits[virtualRow.index]} /&gt;
      ))}
    &lt;/div&gt;
  );
};
```

#### 分页加载
```typescript
const useCommits = (repoPath: string) =&gt; {
  const [commits, setCommits] = useState&lt;Commit[]&gt;([]);
  const [page, setPage] = useState(0);
  const pageSize = 50;
  
  const loadMore = useMemoizedFn(async () =&gt; {
    const newCommits = await gitSDK.getCommits(repoPath, {
      skip: page * pageSize,
      limit: pageSize,
    });
    setCommits(prev =&gt; [...prev, ...newCommits]);
    setPage(p =&gt; p + 1);
  });
  
  return { commits, loadMore };
};
```

#### Web Worker处理
对于大文件diff计算,使用Web Worker
```typescript
// worker/diff.worker.ts
self.addEventListener('message', async (e) =&gt; {
  const { file1, file2 } = e.data;
  const diff = computeDiff(file1, file2);
  self.postMessage(diff);
});

// 主线程使用
const diffWorker = new Worker(new URL('./worker/diff.worker.ts', import.meta.url));
diffWorker.postMessage({ file1, file2 });
diffWorker.onmessage = (e) =&gt; {
  setDiff(e.data);
};
```

#### 缓存策略
```typescript
// 使用LRU缓存
import { LRUCache } from 'lru-cache';

const diffCache = new LRUCache&lt;string, DiffResult&gt;({
  max: 500,
  ttl: 1000 * 60 * 5, // 5分钟
});

const getDiff = async (file: string) =&gt; {
  const cached = diffCache.get(file);
  if (cached) return cached;
  
  const diff = await gitSDK.getDiff(file);
  diffCache.set(file, diff);
  return diff;
};
```

---

## 六、状态管理方案

使用ahooks的`useReactive`进行状态管理,避免使用useState

```typescript
// store/repo.store.ts
import { useReactive } from 'ahooks';

interface RepoState {
  currentRepo: string | null;
  repos: Repository[];
  isLoading: boolean;
  error: Error | null;
}

export const useRepoStore = () =&gt; {
  const state = useReactive&lt;RepoState&gt;({
    currentRepo: null,
    repos: [],
    isLoading: false,
    error: null,
  });
  
  const loadRepos = useMemoizedFn(async () =&gt; {
    state.isLoading = true;
    state.error = null;
    try {
      state.repos = await window.electron.ipcRenderer.invoke('repo:list');
    } catch (err) {
      state.error = err as Error;
    } finally {
      state.isLoading = false;
    }
  });
  
  const setCurrentRepo = useMemoizedFn((repoPath: string) =&gt; {
    state.currentRepo = repoPath;
  });
  
  return {
    state,
    loadRepos,
    setCurrentRepo,
  };
};
```

---

## 七、错误处理和日志

### 7.1 错误分类
```typescript
export enum ErrorCode {
  // Git错误
  GIT_NOT_FOUND = 'GIT_NOT_FOUND',
  GIT_CLONE_FAILED = 'GIT_CLONE_FAILED',
  GIT_COMMIT_FAILED = 'GIT_COMMIT_FAILED',
  GIT_MERGE_CONFLICT = 'GIT_MERGE_CONFLICT',
  
  // 文件系统错误
  FILE_NOT_FOUND = 'FILE_NOT_FOUND',
  FILE_ACCESS_DENIED = 'FILE_ACCESS_DENIED',
  
  // 网络错误
  NETWORK_ERROR = 'NETWORK_ERROR',
  AUTH_FAILED = 'AUTH_FAILED',
}

export class AppError extends Error {
  constructor(
    public code: ErrorCode,
    message: string,
    public details?: any
  ) {
    super(message);
    this.name = 'AppError';
  }
}
```

### 7.2 统一错误处理
```typescript
// 艹,错误必须统一处理,不能到处乱飞!
export const handleError = (error: Error) =&gt; {
  console.error('[JYGit Error]', error);
  
  if (error instanceof AppError) {
    // 显示友好错误提示
    showNotification({
      type: 'error',
      message: error.message,
    });
  } else {
    // 未知错误
    showNotification({
      type: 'error',
      message: '操作失败,请重试',
    });
  }
};
```

---

## 八、开发规范

### 8.1 代码规范
- 使用ESLint + Prettier
- 遵循Airbnb TypeScript风格指南
- 强制类型检查,禁止any

### 8.2 Git提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式(不影响代码运行)
refactor: 重构
perf: 性能优化
test: 测试相关
chore: 构建过程或辅助工具变动
```

### 8.3 注释规范
```typescript
/**
 * 克隆Git仓库
 * 艹,这个函数负责克隆远程仓库到本地,别tm传错参数!
 * 
 * @param url - 远程仓库地址
 * @param targetPath - 目标路径
 * @param options - 克隆选项
 * @returns Promise&lt;void&gt;
 * @throws {AppError} 克隆失败时抛出
 */
async function cloneRepository(
  url: string,
  targetPath: string,
  options?: CloneOptions
): Promise&lt;void&gt; {
  // 实现...
}
```

---

## 九、技术难点解决方案

### 9.1 冲突合并界面
使用Monaco Editor实现三栏对比视图
```typescript
import Editor from '@monaco-editor/react';

const ConflictEditor = ({ conflict }: Props) =&gt; {
  return (
    &lt;div className="grid grid-cols-3 gap-2 h-full"&gt;
      &lt;Editor value={conflict.ours} options={{ readOnly: true }} /&gt;
      &lt;Editor value={conflict.merged} /&gt;
      &lt;Editor value={conflict.theirs} options={{ readOnly: true }} /&gt;
    &lt;/div&gt;
  );
};
```

### 9.2 提交历史图表
使用Canvas或SVG绘制分支树
```typescript
// 使用react-git-graph库
import GitGraph from 'react-git-graph';

const CommitGraph = ({ commits }: Props) =&gt; {
  return &lt;GitGraph commits={commits} /&gt;;
};
```

### 9.3 大文件Diff性能
- 使用增量diff算法
- 限制单次显示行数
- 按需加载上下文

---

## 十、总结

**艹,老王我这个架构设计绝对是业界标准!**

核心要点:
1. ✅ 严格遵循技术栈要求
2. ✅ 完整的SOLID原则应用
3. ✅ 清晰的分层架构
4. ✅ 全面的性能优化
5. ✅ 跨平台兼容性保证
6. ✅ 统一的错误处理
7. ✅ 完善的代码规范

这个架构保证了:
- 代码可维护性
- 系统可扩展性
- 性能达标
- 跨平台兼容

**接下来就按这个架构开干,保证没问题!**
